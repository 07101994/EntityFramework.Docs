<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Concurrency Tokens </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Concurrency Tokens ">
    <meta name="generator" content="docfx 2.5.4.0">
    
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
  </head>
  <body data-spy="scroll" data-target="#affix">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="modeling/concurrency">
              <h1 id="concurrency-tokens" sourcefile="modeling/concurrency.md" sourcestartlinenumber="4" sourceendlinenumber="4">Concurrency Tokens</h1>
              
<div class="WARNING sourceFile=" modeling/concurrency.md"="" sourcestartlinenumber="6" sourceendlinenumber="6" "=""><h5>Warning</h5><p sourcefile="modeling/concurrency.md" sourcestartlinenumber="7" sourceendlinenumber="7">This documentation is for EF Core. For EF6.x and earlier release see <a href="http://msdn.com/data/ef" sourcefile="modeling/concurrency.md" sourcestartlinenumber="7" sourceendlinenumber="7"><a href="http://msdn.com/data/ef" sourcefile="modeling/concurrency.md" sourcestartlinenumber="7" sourceendlinenumber="7">http://msdn.com/data/ef</a></a>.</p>
</div>
<p sourcefile="modeling/concurrency.md" sourcestartlinenumber="9" sourceendlinenumber="9">If a property is configured as a concurrency token then EF will check that no other user has modified that value in the database when saving changes to that record. EF uses an optimistic concurrency pattern, meaning it will assume the value has not changed and try to save the data, but throw if it finds the value has been changed.</p>
<p sourcefile="modeling/concurrency.md" sourcestartlinenumber="11" sourceendlinenumber="11">For example we may want to configure <code>LastName</code> on <code>Person</code> to be a concurrency token. This means that if one user tries to save some changes to a <code>Person</code>, but another user has changed the <code>LastName</code> then an exception will be thrown. This may be desirable so that your application can prompt the user to ensure this record still represents the same actual person before saving their changes.</p>
<h2 id="how-concurrency-tokens-work-in-ef" sourcefile="modeling/concurrency.md" sourcestartlinenumber="13" sourceendlinenumber="13">How concurrency tokens work in EF</h2>
<p sourcefile="modeling/concurrency.md" sourcestartlinenumber="15" sourceendlinenumber="15">Data stores can enforce concurrency tokens by checking that any record being updated or deleted still has the same value for the concurrency token that was assigned when the context originally loaded the data from the database.</p>
<p sourcefile="modeling/concurrency.md" sourcestartlinenumber="17" sourceendlinenumber="17">For example, relational database achieve this by including the concurrency token in the <code>WHERE</code> clause of any <code>UPDATE</code> or <code>DELETE</code> commands and checking the number of rows that were affected. If the concurrency token still matches then one row will be updated. If the value in the database has changed, then no rows are updated.</p>
<!-- literal_block"ids  "classes  "xml:space": "preserve", "backrefs  "linenos": false, "dupnames  : "csharp",, highlight_args}, "names": [] -->
<pre sourcefile="modeling/concurrency.md" sourcestartlinenumber="20" sourceendlinenumber="23"><code class="lang-sql">UPDATE [Person] SET [FirstName] = @p1
WHERE [PersonId] = @p0 AND [LastName] = @p2;
</code></pre><h2 id="conventions" sourcefile="modeling/concurrency.md" sourcestartlinenumber="25" sourceendlinenumber="25">Conventions</h2>
<p sourcefile="modeling/concurrency.md" sourcestartlinenumber="27" sourceendlinenumber="27">By convention, properties are never configured as concurrency tokens.</p>
<h2 id="data-annotations" sourcefile="modeling/concurrency.md" sourcestartlinenumber="29" sourceendlinenumber="29">Data Annotations</h2>
<p sourcefile="modeling/concurrency.md" sourcestartlinenumber="31" sourceendlinenumber="31">You can use the Data Annotations to configure a property as a concurrency token.</p>
<!-- [!code-csharp[Main](samples/Modeling/DataAnnotations/Samples/Concurrency.cs?highlight=4)] -->
<pre sourcefile="modeling/concurrency.md" sourcestartlinenumber="34" sourceendlinenumber="42"><code class="lang-csharp">public class Person
{
    public int PersonId { get; set; }
    [ConcurrencyCheck]
    public string LastName { get; set; }
    public string FirstName { get; set; }
}
</code></pre><h2 id="fluent-api" sourcefile="modeling/concurrency.md" sourcestartlinenumber="44" sourceendlinenumber="44">Fluent API</h2>
<p sourcefile="modeling/concurrency.md" sourcestartlinenumber="46" sourceendlinenumber="46">You can use the Fluent API to configure a property as a concurrency token.</p>
<!-- [!code-csharp[Main](samples/Modeling/FluentAPI/Samples/Concurrency.cs?highlight=7,8,9)] -->
<pre sourcefile="modeling/concurrency.md" sourcestartlinenumber="49" sourceendlinenumber="68"><code class="lang-csharp">class MyContext : DbContext
{
    public DbSet&lt;Person&gt; People { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity&lt;Person&gt;()
            .Property(p =&gt; p.LastName)
            .IsConcurrencyToken();
    }
}

public class Person
{
    public int PersonId { get; set; }
    public string LastName { get; set; }
    public string FirstName { get; set; }
}
</code></pre><h2 id="timestamprow-version" sourcefile="modeling/concurrency.md" sourcestartlinenumber="70" sourceendlinenumber="70">Timestamp/row version</h2>
<p sourcefile="modeling/concurrency.md" sourcestartlinenumber="72" sourceendlinenumber="72">A timestamp is a property where a new value is generated by the database every time a row is inserted or updated. The property is also treated as a concurrency token. This ensures you will get an exception if anyone else has modified a row that you are trying to update since you queried for the data.</p>
<p sourcefile="modeling/concurrency.md" sourcestartlinenumber="74" sourceendlinenumber="74">How this is achieved is up to the database provider being used. For SQL Server, timestamp is usually used on a <em>byte[]</em> property, which will be setup as a <em>ROWVERSION</em> column in the database.</p>
<h3 id="conventions-1" sourcefile="modeling/concurrency.md" sourcestartlinenumber="76" sourceendlinenumber="76">Conventions</h3>
<p sourcefile="modeling/concurrency.md" sourcestartlinenumber="78" sourceendlinenumber="78">By convention, properties are never configured as timestamps.</p>
<h3 id="data-annotations-1" sourcefile="modeling/concurrency.md" sourcestartlinenumber="80" sourceendlinenumber="80">Data Annotations</h3>
<p sourcefile="modeling/concurrency.md" sourcestartlinenumber="82" sourceendlinenumber="82">You can use Data Annotations to configure a property as a timestamp.</p>
<!-- [!code-csharp[Main](samples/Modeling/DataAnnotations/Samples/Timestamp.cs?highlight=6)] -->
<pre sourcefile="modeling/concurrency.md" sourcestartlinenumber="85" sourceendlinenumber="94"><code class="lang-csharp">public class Blog
{
    public int BlogId { get; set; }
    public string Url { get; set; }

    [Timestamp]
    public byte[] Timestamp { get; set; }
}
</code></pre><h3 id="fluent-api-1" sourcefile="modeling/concurrency.md" sourcestartlinenumber="96" sourceendlinenumber="96">Fluent API</h3>
<p sourcefile="modeling/concurrency.md" sourcestartlinenumber="98" sourceendlinenumber="98">You can use the Fluent API to configure a property as a timestamp.</p>
<!-- [!code-csharp[Main](samples/Modeling/FluentAPI/Samples/Timestamp.cs?highlight=7,8,9,10)] -->
<pre sourcefile="modeling/concurrency.md" sourcestartlinenumber="101" sourceendlinenumber="121"><code class="lang-csharp">class MyContext : DbContext
{
    public DbSet&lt;Blog&gt; Blogs { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity&lt;Blog&gt;()
            .Property(p =&gt; p.Timestamp)
            .ValueGeneratedOnAddOrUpdate()
            .IsConcurrencyToken();
    }
}

public class Blog
{
    public int BlogId { get; set; }
    public string Url { get; set; }
    public byte[] Timestamp { get; set; }
}
</code></pre>
            </article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/shirhatti/EntityFramework.Docs/blob/export-qa-fixes/ef/modeling/concurrency.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Copyright © 2015-2016 Microsoft<br>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
  </body>
</html>
